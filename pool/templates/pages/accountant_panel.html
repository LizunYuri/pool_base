{% extends 'components/base.html' %}
{% load static %}

{% block style %}
    <link rel="stylesheet" href="{% static 'css/create_style.css' %}">
{% endblock %}

{% block content %}
    <section class="accountant" id="accountant">
        <div class="container accountant-container">
            <aside class="accountant-aside">
                <div class="accountant-aside-logo">
                    <i class="fa-solid fa-calculator"></i>
                    <h1>Расчетник</h1>
                </div>
                <nav class="accountant-nav">
                    <a class='accountant-link' data-url="/calculation/create-rectangle/">
                        <i class="fa-solid fa-person-swimming"></i>
                        <div class="text">
                            <h2>Прямоугольный бассейн</h2>
                            <p>Типовой скиммерный бассейн</p>
                        </div>
                    </a>
                    <a class='accountant-link' href="#" data-url="/calculation/create-rectangle1/">
                        <i class="fa-solid fa-person-swimming"></i>
                        <div class="text">
                            <h2>Круглый бассейн</h2>
                            <p>Типовой скиммерный бассейн</p>
                        </div>
                    </a>
                </nav>
            </aside>
            <div class="accountant-body">
            </div>
        </div>
    </section>
{% endblock %}

{% block script %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log('DOM полностью загружен');

        // Находим все ссылки
        const links = document.querySelectorAll('.accountant-link');
        const body = document.querySelector('.accountant-body');

        // Функция для загрузки контента через AJAX
        function loadContent(url) {
            console.log('Загрузка контента по URL:', url);
            // Добавляем базовый URL, если он не является абсолютным
            const fullUrl = url.startsWith('http') ? url : `${window.location.origin}${url}`;

            fetch(fullUrl)
                .then(response => {
                    console.log('Получен ответ от сервера:', response);
                    if (!response.ok) {
                        throw new Error('Сетевая ошибка: ' + response.statusText);
                    }
                    return response.text();
                })
                .then(data => {
                    console.log('Контент успешно загружен:', data);
                    // Загружаем контент в accountant-body
                    body.innerHTML = data;

                    // Инициализируем скрипт для материалов после загрузки контента
                    initializeMaterialScript();
                    openModalFunction();
                    resetForm();
                    helpTextVisible();
                })
                .catch(error => {
                    console.error('Ошибка при загрузке контента:', error);
                    body.innerHTML = '<p>Ошибка загрузки контента.</p>';
                });
        }

        // Функция для инициализации скрипта с материалами
        function initializeMaterialScript() {
            console.log('Инициализация скрипта для материалов');
            const materialTypeRadios = document.querySelectorAll('input[name="material_type"]');
            const materialsDropdown = document.getElementById('materials-dropdown');

            if (!materialTypeRadios.length || !materialsDropdown) {
                console.warn('Элементы для инициализации материалов не найдены');
                return; // Выходим, если элементы не найдены
            }

            // Функция для обновления списка материалов
            function updateMaterialsDropdown(materialType) {
                console.log('Обновление списка материалов для типа:', materialType);
                // Отправляем AJAX запрос на сервер для получения материалов
                fetch(`/calculation/get-materials/?type=${materialType}`)
                    .then(response => response.json())
                    .then(data => {
                        console.log('Получены материалы:', data);
                        // Очищаем текущие опции
                        materialsDropdown.innerHTML = '<option value="">Выберите материал</option>';

                        // Добавляем новые опции в выпадающий список
                        data.materials.forEach(material => {
                            let option = document.createElement('option');
                            option.value = material.id;
                            option.text = material.name;
                            materialsDropdown.appendChild(option);
                        });
                    })
                    .catch(error => {
                        console.error('Ошибка при получении материалов:', error);
                    });
            }

            // Слушаем изменения в радио-кнопках
            materialTypeRadios.forEach(radio => {
                radio.addEventListener('change', function () {
                    console.log('Изменен тип материала:', this.value);
                    updateMaterialsDropdown(this.value);
                });
            });

            // Инициализируем с дефолтным значением
            updateMaterialsDropdown(document.querySelector('input[name="material_type"]:checked').value);
        }

        const formQuestion = document.querySelectorAll('.question');
        const resetButton = document.querySelector('button[type="reset"]');
        const clientForm = document.querySelector('.add-client-form');
        const addClientModal = document.getElementById('addClientModal');
        const closeModal = document.querySelector('.close-btn');
        const openModalBtn = document.getElementById('openAddClientModal');

        const openModalFunction = () => {
            if (openModalBtn && addClientModal && closeModal) {
                console.log('Инициализация модального окна');
                openModalBtn.addEventListener('click', () => {
                    console.log('Открытие модального окна');
                    addClientModal.style.display = 'flex';
                });

                closeModal.addEventListener('click', () => {
                    console.log('Закрытие модального окна');
                    addClientModal.style.display = 'none';
                });

                window.addEventListener('click', (event) => {
                    if (event.target === addClientModal) {
                        console.log('Закрытие модального окна кликом вне его');
                        addClientModal.style.display = 'none';
                    }
                });
            } else {
                console.warn('Элементы модального окна не найдены');
            }
        }

        const resetForm = () => {
            if (resetButton && clientForm) {
                resetButton.addEventListener('click', () => {
                    console.log('Сброс формы');
                    clientForm.reset(); // Сбрасываем форму
                });
            } else {
                console.warn('Элементы формы не найдены');
            }
        }

        const helpTextVisible = () => {
            console.log('Инициализация всплывающих подсказок');
            formQuestion.forEach((question) => {
                question.addEventListener('mouseenter', () => {
                    const helpText = question.nextElementSibling; // Получаем следующий элемент (help-text)
                    if (helpText && helpText.classList.contains('help-text')) {
                        console.log('Показ всплывающей подсказки для:', question);
                        helpText.style.display = 'flex'; // Показываем help-text при наведении
                    }
                });

                question.addEventListener('mouseleave', () => {
                    const helpText = question.nextElementSibling; // Получаем следующий элемент (help-text)
                    if (helpText && helpText.classList.contains('help-text')) {
                        console.log('Скрытие всплывающей подсказки для:', question);
                        helpText.style.display = 'none'; // Скрываем help-text при уходе курсора
                    }
                });
            });
        }

        // Обработка клика по ссылке
        links.forEach(link => {
            link.addEventListener('click', function (event) {
                event.preventDefault();  // Отключаем стандартное поведение ссылки
                console.log('Клик по ссылке:', this.textContent);

                // Удаляем класс active у всех ссылок
                links.forEach(l => l.classList.remove('accountant-active'));

                // Добавляем класс active для текущей ссылки
                this.classList.add('accountant-active');

                // Загружаем контент для данной ссылки
                const url = this.getAttribute('data-url');
                loadContent(url);
            });
        });
    });
</script>
{% endblock %}
